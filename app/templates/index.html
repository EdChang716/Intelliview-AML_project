<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Intelliview Coach â€“ Resume Setup</title>
  <link rel="stylesheet" href="/static/style.css?v=10" />
  <link rel="stylesheet" href="/static/resume.css?v=10" />
  <link rel="stylesheet" href="/static/global-nav.css?v=10" />
</head>

<body>
  <div class="app-container">
    <!-- Top navï¼Œä¸€æ¨£çš„é¢¨æ ¼ -->
    <header class="top-nav">
      <div class="nav-left">
        <div class="logo-dot"></div>
        <span class="logo-text">Intelliview&nbsp;Coach</span>
      </div>
      <nav class="nav-links">
        <a href="/">Home</a>
        <a href="{{ request.url_for('resume_page') }}" class="nav-active">Resume</a>
        <a href="{{ request.url_for('profiles_page') }}">Profiles</a>
        <a href="{{ request.url_for('mock_settings_page') }}">Mock Interview</a>
      </nav>
    </header>

    <!-- Page header -->
    <main>
      <section class="page-header">
        <h1>Resume setup</h1>
        <p class="page-subtitle">
          Upload your resume, parse it into structured sections, and refine your experience
          before practicing interviews.
        </p>
        <div class="page-steps">
          <span class="step-pill">1 Â· Upload & parse</span>
          <span class="step-pill">2 Â· Edit experience & education</span>
          <span class="step-pill">3 Â· Build embeddings for RAG</span>
        </div>
      </section>

      <!-- Phase 0: Resume List -->
      <section class="card" id="list-section">
        <div class="profiles-header">
          <h2 class="section-title">Your Resumes</h2>
          <button id="btn-add-resume" class="btn primary-btn">+ Add New Resume</button>
        </div>
        <p class="section-subtitle">Manage your resume versions. Edit entries or delete old versions.</p>
        <div id="resume-list-container" class="profile-grid">
          <!-- Resumes will be injected here via JS -->
          <p>Loading...</p>
        </div>
      </section>

      <!-- Step 1: Upload (Hidden by default) -->
      <section class="card" id="upload-section" style="display:none;">
        <div class="row-spaced">
          <h2 class="section-title">1. Upload Resume</h2>
          <button id="btn-cancel-upload" class="btn ghost-btn small-btn">Cancel</button>
        </div>
        <p class="section-subtitle">
          Give this resume a name (e.g. <code>resume_DS</code>), then upload your PDF.
        </p>
        <form id="upload-form" class="upload-form">
          <label class="field-group">
            <span class="field-label">Profile ID (Unique Name)</span>
            <input type="text" id="project-id-input" name="project_id" placeholder="e.g. resume_DS" required />
          </label>
          <label class="field-group">
            <span class="field-label">Resume PDF</span>
            <input type="file" id="resume-file-input" name="file" accept="application/pdf" required />
          </label>
          <div class="button-row">
            <button type="submit" class="btn primary-btn">
              Upload &amp; Parse
            </button>
          </div>
        </form>
        <p id="upload-status" class="status-text"></p>
      </section>

      <!-- Step 2: Editor (Hidden by default) -->
      <section class="card" id="editor-section" style="display:none;">
        <div class="row-spaced">
          <h2 class="section-title">Edit Resume: <span id="editor-project-id"></span></h2>
          <button id="btn-cancel-edit" class="btn ghost-btn small-btn">Back to List</button>
        </div>
        <p class="section-subtitle">
          Adjust entries, bullets, and education. These will be used to build embeddings
          for your interview practice.
        </p>

        <div class="editor-layout">
          <!-- å·¦é‚Šï¼šExperience / Projects -->
          <div class="editor-column">
            <h3>Experience &amp; Projects</h3>
            <div id="experience-container"></div>
            <div class="button-row">
              <button id="add-experience-btn" type="button" class="btn ghost-btn">
                + Add Experience
              </button>
              <button id="add-project-btn" type="button" class="btn ghost-btn">
                + Add Project
              </button>
            </div>
          </div>

          <!-- å³é‚Šï¼šEducation + Skills / Courses tags -->
          <div class="editor-column">
            <h3>Education &amp; Profile</h3>

            <!-- Education structured cards -->
            <div id="education-container"></div>

            <!-- Skills tags -->
            <div class="tag-section">
              <label class="block-label">Skills</label>
              <div id="skills-tags" class="tag-container"></div>
              <div class="tag-input-row">
                <input id="new-skill-input" type="text" placeholder="Add a skill and press Enter" />
                <button type="button" id="add-skill-btn" class="btn small-btn ghost-btn">
                  Add
                </button>
              </div>
            </div>

            <!-- Courses tags -->
            <div class="tag-section">
              <label class="block-label">Courses</label>
              <div id="courses-tags" class="tag-container"></div>
              <div class="tag-input-row">
                <input id="new-course-input" type="text" placeholder="Add a course and press Enter" />
                <button type="button" id="add-course-btn" class="btn small-btn ghost-btn">
                  Add
                </button>
              </div>
            </div>

            <!-- Other / profile free text -->
            <label class="block-label">
              Profile / Other
              <textarea id="meta-other" rows="4" placeholder="Short summary or notes for this profile"></textarea>
            </label>
          </div>
        </div>

        <div class="save-row">
          <button id="save-btn" type="button" class="btn primary-btn">
            Save edited resume
          </button>
          <span id="save-status" class="status-text"></span>
        </div>
      </section>
    </main>
  </div>

  <!-- ä¸‹é¢ JS å®Œå…¨ç…§ä½ åŸä¾†çš„ï¼Œåªæ˜¯ç§»åˆ° body æœ€å¾Œ -->
  <script>
    // ===========================
    // å…¨åŸŸ state
    // ===========================
    let currentState = {
      project_id: null,
      entries: [],
      groupedEntries: {},
      metadata: {},
      education_structured: [],
      skillsList: [],
      coursesList: []
    };

    // ===========================
    // å·¥å…·ï¼šä¾ entry åˆ†çµ„ bullets
    // ===========================
    function groupEntries(entries) {
      const grouped = {};
      const byKey = {};

      entries.forEach((e) => {
        const section = e.section || "EXPERIENCE";
        const entry = e.entry || "Untitled Entry";
        const text = e.text || "";
        const location = e.location || "";
        const dates = e.dates || "";

        const key = section + "||" + entry;
        if (!byKey[key]) {
          byKey[key] = { section, entry, location, dates, bullets: [] };
        }
        byKey[key].bullets.push(text);
      });

      Object.values(byKey).forEach((obj) => {
        if (!grouped[obj.section]) grouped[obj.section] = [];
        grouped[obj.section].push(obj);
      });

      return grouped;
    }

    // ===========================
    // Experience / Projects editor
    // æ¯å€‹ bullet ä¸€å€‹ input box
    // ===========================
    function renderExperienceEditor() {
      const container = document.getElementById("experience-container");
      container.innerHTML = "";

      // Use all sections from the grouped data instead of hardcoded list
      const sections = Object.keys(currentState.groupedEntries);
      sections.forEach((sec) => {
        const sectionEntries = currentState.groupedEntries[sec] || [];
        if (sectionEntries.length === 0) return;

        const secHeader = document.createElement("h4");
        secHeader.textContent = sec;
        container.appendChild(secHeader);

        sectionEntries.forEach((entryObj, idx) => {
          const wrapper = document.createElement("div");
          wrapper.className = "entry-card";
          wrapper.dataset.section = sec;
          wrapper.dataset.index = idx;

          // Title row with delete icon
          const titleRow = document.createElement("div");
          titleRow.style.display = "flex";
          titleRow.style.alignItems = "center";
          titleRow.style.gap = "8px";
          titleRow.style.marginBottom = "8px";

          const titleInput = document.createElement("input");
          titleInput.className = "entry-title";
          titleInput.value = entryObj.entry || "";
          titleInput.placeholder = sec === "EXPERIENCE" ? "Company â€” Role" : "Project title";
          titleInput.style.flex = "1";

          const deleteIcon = document.createElement("button");
          deleteIcon.type = "button";
          deleteIcon.innerHTML = "ğŸ—‘ï¸";
          deleteIcon.className = "icon-btn";
          deleteIcon.title = "Delete Entry";
          deleteIcon.style.background = "none";
          deleteIcon.style.border = "none";
          deleteIcon.style.cursor = "pointer";
          deleteIcon.style.fontSize = "18px";
          deleteIcon.style.padding = "4px";
          deleteIcon.onclick = () => {
            const list = currentState.groupedEntries[sec];
            list.splice(idx, 1);
            renderExperienceEditor();
          };

          titleRow.appendChild(titleInput);
          titleRow.appendChild(deleteIcon);
          wrapper.appendChild(titleRow);

          // Location and Dates row
          const metaRow = document.createElement("div");
          metaRow.style.display = "flex";
          metaRow.style.gap = "8px";
          metaRow.style.marginBottom = "8px";

          const locationInput = document.createElement("input");
          locationInput.className = "entry-meta-input";
          locationInput.value = entryObj.location || "";
          locationInput.placeholder = "Location (e.g., Boston, MA)";
          locationInput.dataset.field = "location";
          locationInput.style.flex = "1";

          const datesInput = document.createElement("input");
          datesInput.className = "entry-meta-input";
          datesInput.value = entryObj.dates || "";
          datesInput.placeholder = "Dates (e.g., Apr 2023 - May 2024)";
          datesInput.dataset.field = "dates";
          datesInput.style.flex = "1";

          metaRow.appendChild(locationInput);
          metaRow.appendChild(datesInput);
          wrapper.appendChild(metaRow);

          // bullets container
          const bulletsLabel = document.createElement("div");
          bulletsLabel.textContent = "Bullets";
          bulletsLabel.className = "small-label";
          wrapper.appendChild(bulletsLabel);

          const bulletsContainer = document.createElement("div");
          bulletsContainer.className = "bullets-container";

          const bullets = entryObj.bullets && entryObj.bullets.length
            ? entryObj.bullets
            : [""];

          bullets.forEach((b) => {
            const row = document.createElement("div");
            row.className = "bullet-row";

            const input = document.createElement("input");
            input.type = "text";
            input.className = "bullet-input";
            input.value = b;

            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.textContent = "Ã—";
            delBtn.className = "bullet-delete-btn";
            delBtn.onclick = () => {
              row.remove();
            };

            row.appendChild(input);
            row.appendChild(delBtn);
            bulletsContainer.appendChild(row);
          });

          wrapper.appendChild(bulletsContainer);

          // row of buttons under entry
          const btnRow = document.createElement("div");
          btnRow.className = "entry-button-row";

          const addBulletBtn = document.createElement("button");
          addBulletBtn.type = "button";
          addBulletBtn.textContent = "+ Bullet";
          addBulletBtn.onclick = () => {
            const row = document.createElement("div");
            row.className = "bullet-row";
            const input = document.createElement("input");
            input.type = "text";
            input.className = "bullet-input";
            input.placeholder = "New bullet point";
            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.textContent = "Ã—";
            delBtn.className = "bullet-delete-btn";
            delBtn.onclick = () => row.remove();
            row.appendChild(input);
            row.appendChild(delBtn);
            bulletsContainer.appendChild(row);
          };
          btnRow.appendChild(addBulletBtn);

          wrapper.appendChild(btnRow);
          container.appendChild(wrapper);
        });
      });
    }

    // å¾ DOM æ”¶é›† entriesï¼ˆæ‰å¹³åŒ–å›åŸæœ¬æ ¼å¼ï¼‰
    function collectEntriesFromEditor() {
      const container = document.getElementById("experience-container");
      const entryCards = container.querySelectorAll(".entry-card");
      const entries = [];

      entryCards.forEach((card) => {
        const section = card.dataset.section || "EXPERIENCE";
        const title = card.querySelector(".entry-title").value.trim();

        // Get location and dates
        const locationInput = card.querySelector('[data-field="location"]');
        const datesInput = card.querySelector('[data-field="dates"]');
        const location = locationInput ? locationInput.value.trim() : "";
        const dates = datesInput ? datesInput.value.trim() : "";

        const bulletInputs = card.querySelectorAll(".bullet-input");

        bulletInputs.forEach((inp) => {
          const text = inp.value.trim();
          if (!text) return;
          entries.push({
            section,
            entry: title || "Untitled Entry",
            location,
            dates,
            text
          });
        });
      });

      return entries;
    }

    // ===========================
    // Education structured UI
    // ===========================
    function renderEducationEditor() {
      const container = document.getElementById("education-container");
      container.innerHTML = "";

      const schools = currentState.education_structured || [];
      if (!schools.length) return;

      const title = document.createElement("h4");
      title.textContent = "Education (structured)";
      container.appendChild(title);

      schools.forEach((s, idx) => {
        const card = document.createElement("div");
        card.className = "edu-card";
        card.dataset.index = idx;

        const schoolInput = document.createElement("input");
        schoolInput.className = "edu-input";
        schoolInput.value = s.school_name || "";
        schoolInput.placeholder = "School name";
        schoolInput.dataset.field = "school_name";

        const degreeInput = document.createElement("input");
        degreeInput.className = "edu-input";
        degreeInput.value = s.degree || "";
        degreeInput.placeholder = "Degree / Program";
        degreeInput.dataset.field = "degree";

        const majorInput = document.createElement("input");
        majorInput.className = "edu-input";
        majorInput.value = s.major || "";
        majorInput.placeholder = "Major / Field of Study";
        majorInput.dataset.field = "major";

        const datesInput = document.createElement("input");
        datesInput.className = "edu-input";
        datesInput.value = s.dates || "";
        datesInput.placeholder = "Dates";
        datesInput.dataset.field = "dates";

        const gpaInput = document.createElement("input");
        gpaInput.className = "edu-input";
        gpaInput.value = s.gpa || "";
        gpaInput.placeholder = "GPA";
        gpaInput.dataset.field = "gpa";

        card.appendChild(schoolInput);
        card.appendChild(degreeInput);
        card.appendChild(majorInput);
        card.appendChild(datesInput);
        card.appendChild(gpaInput);

        container.appendChild(card);
      });
    }

    function collectEducationFromEditor() {
      const container = document.getElementById("education-container");
      const cards = container.querySelectorAll(".edu-card");

      const schools = [];
      cards.forEach((card) => {
        const idx = parseInt(card.dataset.index, 10);
        const original = currentState.education_structured[idx] || {};
        const inputs = card.querySelectorAll(".edu-input");
        const updated = { ...original };

        inputs.forEach((inp) => {
          const field = inp.dataset.field;
          updated[field] = inp.value;
        });

        schools.push(updated);
      });

      return schools;
    }

    // ===========================
    // Skills / Courses tags
    // ===========================
    function splitToTags(text) {
      if (!text) return [];
      return text
        .split(/[\n,;]/)
        .map((t) => t.trim())
        .filter((t) => t.length > 0);
    }

    function renderTagList(list, containerId, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      list.forEach((item, idx) => {
        const tag = document.createElement("span");
        tag.className = "tag";

        const spanText = document.createElement("span");
        spanText.className = "tag-text";
        spanText.textContent = item;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-remove-btn";
        btn.textContent = "Ã—";
        btn.onclick = () => {
          if (type === "skills") currentState.skillsList.splice(idx, 1);
          if (type === "courses") currentState.coursesList.splice(idx, 1);
          rerenderTags();
        };

        tag.appendChild(spanText);
        tag.appendChild(btn);
        container.appendChild(tag);
      });
    }

    function rerenderTags() {
      renderTagList(currentState.skillsList, "skills-tags", "skills");
      renderTagList(currentState.coursesList, "courses-tags", "courses");
    }

    function setupTagInput(inputId, btnId, type) {
      const input = document.getElementById(inputId);
      const btn = document.getElementById(btnId);

      function addTag() {
        const val = input.value.trim();
        if (!val) return;
        if (type === "skills") currentState.skillsList.push(val);
        if (type === "courses") currentState.coursesList.push(val);
        input.value = "";
        rerenderTags();
      }

      btn.addEventListener("click", addTag);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addTag();
        }
      });
    }

    // ===========================
    // UI Switching and Initialization
    // ===========================
    const listSection = document.getElementById("list-section");
    const uploadSection = document.getElementById("upload-section");
    const editorSection = document.getElementById("editor-section");
    const resumeListContainer = document.getElementById("resume-list-container");

    function showList() {
      listSection.style.display = "block";
      uploadSection.style.display = "none";
      editorSection.style.display = "none";
      fetchResumes();
    }

    function showUpload() {
      listSection.style.display = "none";
      uploadSection.style.display = "block";
      editorSection.style.display = "none";
      document.getElementById("project-id-input").value = "";
      document.getElementById("resume-file-input").value = "";
      document.getElementById("upload-status").textContent = "";
    }

    function showEditor() {
      listSection.style.display = "none";
      uploadSection.style.display = "none";
      editorSection.style.display = "block";
      document.getElementById("editor-project-id").textContent = currentState.project_id;
    }

    // List fetching
    async function fetchResumes() {
      try {
        resumeListContainer.innerHTML = "<p>Loading...</p>";
        const res = await fetch("/api/resumes");
        if (!res.ok) throw new Error("Failed to fetch");
        const data = await res.json();
        renderResumeList(data.resumes);
      } catch (e) {
        resumeListContainer.innerHTML = "<p>Error loading resumes.</p>";
        console.error(e);
      }
    }

    function renderResumeList(resumes) {
      if (!resumes || resumes.length === 0) {
        resumeListContainer.innerHTML = "<p>No resumes found.</p>";
        return;
      }
      resumeListContainer.innerHTML = "";
      resumes.forEach(r => {
        const card = document.createElement("article");
        card.className = "profile-card";
        // Unique ID for dropdown
        const menuId = "menu-" + r.resume_id;

        card.innerHTML = `
                <div class="menu-container abs-top-right">
                    <button class="menu-btn" onclick="toggleMenu('${menuId}')">â‹®</button>
                    <div id="${menuId}" class="menu-dropdown">
                        <button class="menu-item" onclick="editResume('${r.resume_id}')">
                            âœï¸ Edit
                        </button>
                        <button class="menu-item danger-text" onclick="deleteResume('${r.resume_id}')">
                            ğŸ—‘ï¸ Delete
                        </button>
                    </div>
                </div>

                <header class="profile-header-row">
                    <div>
                        <h3 class="profile-title">${r.resume_id}</h3>
                        <p class="profile-company">Resume</p>
                    </div>
                </header>

                <div class="profile-body">
                    <p class="profile-snippet">Resume ID: ${r.resume_id}</p>
                </div>
            `;
        resumeListContainer.appendChild(card);
      });
    }

    // Toggle menu dropdown
    window.toggleMenu = function (menuId) {
      // close all others
      document.querySelectorAll('.menu-dropdown').forEach(el => {
        if (el.id !== menuId) el.classList.remove('show');
      });
      const menu = document.getElementById(menuId);
      if (menu) menu.classList.toggle('show');
    };

    // Close menus when clicking outside
    window.addEventListener('click', function (e) {
      if (!e.target.matches('.menu-btn')) {
        document.querySelectorAll('.menu-dropdown').forEach(el => {
          el.classList.remove('show');
        });
      }
    });

    // Actions
    window.editResume = async function (projectId) {
      try {
        const res = await fetch(`/api/resume/${projectId}`);
        if (!res.ok) throw new Error("Failed to load");
        const data = await res.json();

        // Populate state
        currentState.project_id = data.project_id;
        currentState.entries = data.entries || [];
        currentState.metadata = data.metadata || {};
        currentState.education_structured = data.education_structured || [];

        currentState.groupedEntries = groupEntries(currentState.entries);
        currentState.skillsList = splitToTags(currentState.metadata.SKILLS || "");

        // Extract courses from education_structured and merge with metadata.COURSES
        const educationCourses = [];
        (data.education_structured || []).forEach(school => {
          if (school.courses && school.courses.length > 0) {
            school.courses.forEach(courseStr => {
              educationCourses.push(courseStr);
            });
          }
        });
        const metadataCourses = currentState.metadata.COURSES || "";
        const allCourses = metadataCourses ? metadataCourses + "\n" + educationCourses.join("\n") : educationCourses.join("\n");
        currentState.coursesList = splitToTags(allCourses);

        document.getElementById("meta-other").value = currentState.metadata.OTHER || "";

        renderExperienceEditor();
        renderEducationEditor();
        rerenderTags();
        document.getElementById("save-status").textContent = "";
        showEditor();
      } catch (e) {
        alert("Error loading resume data: " + e);
      }
    };

    window.deleteResume = async function (projectId) {
      if (!confirm(`Are you sure you want to delete ${projectId}? This cannot be undone.`)) return;
      try {
        const res = await fetch(`/api/resume/${projectId}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Failed to delete");
        fetchResumes();
      } catch (e) {
        alert("Error deleting resume: " + e);
      }
    };

    // Event Listeners
    document.getElementById("btn-add-resume").addEventListener("click", showUpload);
    document.getElementById("btn-cancel-upload").addEventListener("click", showList);
    document.getElementById("btn-cancel-edit").addEventListener("click", showList);
    document.getElementById("upload-form").addEventListener("submit", async (e) => {
      // ... (existing submit logic, mostly same but calls showEditor at end)
      e.preventDefault();
      const uploadStatus = document.getElementById("upload-status");
      uploadStatus.textContent = "Uploading and parsing...";

      const projectId = document.getElementById("project-id-input").value.trim();
      const fileInput = document.getElementById("resume-file-input");
      if (!projectId || !fileInput.files.length) {
        uploadStatus.textContent = "Please provide profile ID and choose a PDF file.";
        return;
      }

      const formData = new FormData();
      formData.append("project_id", projectId);
      formData.append("file", fileInput.files[0]);

      try {
        const resp = await fetch("/api/upload_resume", {
          method: "POST",
          body: formData
        });
        if (!resp.ok) {
          uploadStatus.textContent = "Upload failed: " + resp.statusText;
          return;
        }
        const data = await resp.json();
        // Load into editor
        currentState.project_id = data.project_id;
        currentState.entries = data.entries || [];
        currentState.metadata = data.metadata || {};
        currentState.education_structured = data.education_structured || [];
        currentState.groupedEntries = groupEntries(currentState.entries);
        currentState.skillsList = splitToTags(currentState.metadata.SKILLS || "");

        // Extract courses from education_structured and merge with metadata.COURSES
        const educationCourses = [];
        (data.education_structured || []).forEach(school => {
          if (school.courses && school.courses.length > 0) {
            school.courses.forEach(courseStr => {
              educationCourses.push(courseStr);
            });
          }
        });
        const metadataCourses = currentState.metadata.COURSES || "";
        const allCourses = metadataCourses ? metadataCourses + "\n" + educationCourses.join("\n") : educationCourses.join("\n");
        currentState.coursesList = splitToTags(allCourses);

        document.getElementById("meta-other").value = currentState.metadata.OTHER || "";

        renderExperienceEditor();
        renderEducationEditor();
        rerenderTags();
        showEditor();
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "Error parsing resume.";
      }
    });

    // Save button (mostly same)
    const saveBtn = document.getElementById("save-btn");
    const saveStatus = document.getElementById("save-status");

    saveBtn.addEventListener("click", async () => {
      if (!currentState.project_id) {
        saveStatus.textContent = "No profile loaded.";
        return;
      }
      const entries = collectEntriesFromEditor();
      const education_structured = collectEducationFromEditor();
      const metadata = {
        ...currentState.metadata,
        SKILLS: currentState.skillsList.join("\n"),
        COURSES: currentState.coursesList.join("\n"),
        OTHER: document.getElementById("meta-other").value
      };

      const payload = {
        project_id: currentState.project_id,
        entries,
        metadata,
        education_structured
      };
      saveStatus.textContent = "Saving...";
      try {
        const resp = await fetch("/api/save_resume", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          saveStatus.textContent = "Save failed: " + resp.statusText;
          return;
        }

        // Success Logic:
        saveStatus.textContent = "Saved!";
        // Delay slightly then go back to list
        setTimeout(() => {
          showList();
        }, 800);

      } catch (err) {
        console.error(err);
        saveStatus.textContent = "Error saving.";
      }
    });

    // Initial load
    fetchResumes();

    // ===========================
    // åˆå§‹åŒ– tag input äº‹ä»¶
    // ===========================
    setupTagInput("new-skill-input", "add-skill-btn", "skills");
    setupTagInput("new-course-input", "add-course-btn", "courses");


    // ===========================
    // 20261209 æ–°å¢ Add Experience / Project çš„é‚è¼¯ 
    // ===========================
    function addNewEntry(sectionName) {
      // 1. ã€é—œéµæ­¥é©Ÿã€‘åœ¨æ–°å¢ä¹‹å‰ï¼Œå…ˆå¾ç•«é¢æ”¶é›†ç›®å‰ä½¿ç”¨è€…å·²ç¶“è¼¸å…¥çš„å…§å®¹
      // é€™æ¨£æ‰ä¸æœƒå› ç‚ºé‡æ–°æ¸²æŸ“ (render) è€Œå°è‡´å‰›å‰›æ‰“çš„å­—æ¶ˆå¤±
      const currentFlatEntries = collectEntriesFromEditor();
      
      // 2. æ›´æ–°å…¨åŸŸç‹€æ…‹
      currentState.groupedEntries = groupEntries(currentFlatEntries);

      // 3. ç¢ºä¿è©²å€å¡Šé™£åˆ—å­˜åœ¨
      if (!currentState.groupedEntries[sectionName]) {
        currentState.groupedEntries[sectionName] = [];
      }

      // 4. æ¨å…¥ä¸€å€‹æ–°çš„ç©ºç™½é …ç›®
      currentState.groupedEntries[sectionName].push({
        section: sectionName,
        entry: "",       
        bullets: [""]    
      });

      // 5. é‡æ–°æ¸²æŸ“ç•«é¢ (é€™æ™‚å€™ç‹€æ…‹å·²ç¶“åŒ…å«èˆŠçš„è¼¸å…¥ + æ–°çš„ç©ºç™½é …)
      renderExperienceEditor();
    }
    
    const addExpBtn = document.getElementById("add-experience-btn");
    if (addExpBtn) {
      addExpBtn.addEventListener("click", function() {
        addNewEntry("EXPERIENCE");
      });
    }

    const addProjBtn = document.getElementById("add-project-btn");
    if (addProjBtn) {
      addProjBtn.addEventListener("click", function() {
        addNewEntry("PROJECTS");
      });
    }

  </script>
</body>

</html>